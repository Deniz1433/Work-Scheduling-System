<!-- src/main/resources/templates/role-hierarchy.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>Interactive Role Hierarchy</title>

    <meta name="_csrf"       th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

    <script src="https://unpkg.com/cytoscape@3.24.0/dist/cytoscape.min.js"></script>

    <style>
        body { display:flex; height:100vh; margin:0; font-family:sans-serif; }
        #sidebar { width:240px; padding:1rem; box-sizing:border-box; border-right:1px solid #ccc; overflow:auto; }
        .mode-btn, #saveBtn, #backBtn { display:block; margin-bottom:.5rem; padding:.5rem; width:100%; border:none; border-radius:4px; cursor:pointer; font-weight:bold }
        .mode-btn { background:#ddd; color:#000 }
        .mode-btn.active { background:#48c; color:#fff }
        #saveBtn { background:#4caf50; color:#fff }
        #saveBtn:hover { background:#3e8e41 }
        #backBtn { background:#888; color:#fff }
        #backBtn:hover { background:#666 }
        #cy, #cy canvas { flex:1; width:100%; height:100%; display:block }
        .role-item { cursor:pointer; padding:4px; border:1px solid #999; margin:4px 0; background:#fafafa; user-select:none }
        .role-item:hover { background:#eef }
        .selected { overlay-color:yellow; overlay-opacity:0.3; overlay-padding:6px }
    </style>
</head>
<body>

<div id="sidebar">
    <!-- Back to Dashboard Button -->
    <button id="backBtn">Back to Dashboard</button>
    <button id="moveBtn" class="mode-btn">Move Mode</button>
    <button id="arrowBtn" class="mode-btn">Arrow Mode</button>
    <button id="saveBtn">Save Hierarchy</button>

    <h2>Roles</h2>
    <div th:each="r : ${roles}" class="role-item" th:text="${r}"></div>

    <hr/>
    <p><strong>Instructions:</strong></p>
    <ul>
        <li>Click a role to add it.</li>
        <li><strong>Move Mode:</strong> drag & drop; click node to delete.</li>
        <li><strong>Arrow Mode:</strong> click source, then click target to connect.</li>
        <li>When done, hit “Save Hierarchy” to persist positions & links.</li>
    </ul>
</div>

<div id="cy"></div>

<script th:inline="javascript">
    /*<![CDATA[*/
    console.clear();

    // CSRF tokens
    const csrfToken  = /*[[${_csrf.token}]]*/ '';
    const csrfHeader = /*[[${_csrf.headerName}]]*/ '';

    // track unsaved changes
    let isDirty = false;
    const markDirty = () => { isDirty = true; };

    // load maps from server
    const childrenMap  = /*[[${childrenMap}]]*/ {};
    const positionsMap = /*[[${positionsMap}]]*/ {};

    // build elements
    const elements = [];
    Object.entries(childrenMap).forEach(([p,kids]) => {
        const posP = positionsMap[p];
        elements.push({ data:{ id:p, label:p }, position: posP ? { x: posP.x, y: posP.y } : undefined });
        kids.forEach(c => {
            const posC = positionsMap[c];
            elements.push({ data:{ id:c, label:c }, position: posC ? { x: posC.x, y: posC.y } : undefined });
            elements.push({ data:{ id:p+'→'+c, source:p, target:c } });
        });
    });

    // init Cytoscape
    const cy = cytoscape({ container: document.getElementById('cy'), elements,
        style:[
            { selector:'node', style:{ shape:'round-rectangle', width:'label', height:'label', padding:'8px', label:'data(label)', 'text-valign':'center','background-color':'#66c','color':'#fff','font-size':'12px' }},
            { selector:'edge', style:{ 'curve-style':'bezier','target-arrow-shape':'triangle','line-color':'#888','target-arrow-color':'#888' }},
            { selector:'.selected', style:{ 'overlay-color':'yellow','overlay-opacity':0.3,'overlay-padding':'6px' }}
        ], layout:{ name:'preset' }
    });

    // mark dirty on changes
    cy.on('add remove', 'edge', markDirty);
    cy.on('dragfree', 'node', markDirty);
    const deleteHandler = evt => { cy.remove(evt.target); markDirty(); };
    let src = null;
    const arrowHandler = evt => {
        const tgt = evt.target;
        if (!src) { src = tgt; tgt.addClass('selected'); }
        else if (tgt.id()!==src.id()) {
            cy.add({ data:{ id:src.id()+'→'+tgt.id(), source:src.id(), target:tgt.id() } });
            src.removeClass('selected'); src=null; markDirty();
        }
    };

    function enableMove(){ cy.autoungrabify(false); cy.off('tap','node',arrowHandler); cy.on('tap','node',deleteHandler); moveBtn.classList.add('active'); arrowBtn.classList.remove('active'); src=null; cy.nodes('.selected').removeClass('selected'); }
    function enableArrow(){ cy.autoungrabify(true); cy.off('tap','node',deleteHandler); cy.on('tap','node',arrowHandler); arrowBtn.classList.add('active'); moveBtn.classList.remove('active'); }
    const moveBtn  = document.getElementById('moveBtn');
    const arrowBtn = document.getElementById('arrowBtn');
    moveBtn.onclick=enableMove; arrowBtn.onclick=enableArrow; enableMove();

    // Save
    document.getElementById('saveBtn').addEventListener('click',()=>{
        const seen=new Set();
        const rels=cy.edges().map(e=>({parent:e.data('source'),child:e.data('target')})).filter(p=>!seen.has(p.parent+'→'+p.child)&&seen.add(p.parent+'→'+p.child));
        const poss=cy.nodes().map(n=>({role:n.id(),x:n.position('x'),y:n.position('y')}));
        fetch('/admin/hierarchy/save',{method:'POST',headers:{'Content-Type':'application/json',[csrfHeader]:csrfToken},body:JSON.stringify({relations:rels,positions:poss})})
            .then(r=>r.text().then(txt=>({ok:r.ok,txt}))).then(({ok,txt})=>{if(ok){alert('Saved!');isDirty=false;}else alert('Save failed: '+txt);}).catch(e=>{console.error(e);alert('Save error—see console');});
    });

    // Warn on leave
    window.addEventListener('beforeunload',e=>{if(isDirty){e.returnValue='You have unsaved changes.';return'e';}});

    // Back to Dashboard
    document.getElementById('backBtn').addEventListener('click',()=>{
        if(isDirty&& !confirm('You have unsaved changes. Leave anyway?'))return;
        window.location.href='/'
    });

    console.log('ROLE-SCRIPT: ready');
    /*]]>*/
</script>

</body>
</html>
